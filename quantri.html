<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HỆ THỐNG ĐIỀU HÀNH TÁC CHIẾN CỨU HỘ</title>
  
  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body { 
        font-family: 'Inter', sans-serif; 
        background-color: #0f172a; 
        color: #e2e8f0; 
        margin: 0; 
        overflow-x: hidden;
    }
    
    /* Glassmorphism */
    .glass-panel { 
        background: rgba(30, 41, 59, 0.7); 
        backdrop-filter: blur(16px); 
        -webkit-backdrop-filter: blur(16px); 
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    
    /* Map & Markers */
    #map { height: 550px; border-radius: 1rem; z-index: 1; }
    .marker-pin { width: 36px; height: 36px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); background: #ef4444; box-shadow: 0 0 15px #ef4444; position: relative; }
    .marker-pin::after { content: ''; position: absolute; width: 14px; height: 14px; background: white; border-radius: 50%; top: 11px; left: 11px; }
    .marker-rescue { background: #3b82f6 !important; box-shadow: 0 0 15px #3b82f6 !important; }
    .marker-warning { background: #f59e0b !important; box-shadow: 0 0 15px #f59e0b !important; }
    
    /* Animations */
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    
    /* Editor buttons */
    .editor-btn { @apply p-2 rounded hover:bg-slate-600 text-slate-300 hover:text-white transition-colors; }
  </style>
</head>
<body class="min-h-screen bg-[url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')] bg-cover bg-fixed bg-center">
  <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm"></div>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="relative z-50 flex items-center justify-center min-h-screen p-4">
    <div class="glass-panel p-8 md:p-12 rounded-3xl shadow-2xl w-full max-w-md border-t border-white/10 flex flex-col items-center">
      <div class="w-20 h-20 bg-red-600 rounded-2xl flex items-center justify-center shadow-lg shadow-red-500/30 mb-6">
        <i class="fas fa-shield-halved text-4xl text-white"></i>
      </div>
      <h1 class="text-3xl font-black text-white mb-1 tracking-tight">HỆ THỐNG CHỈ HUY</h1>
      <p class="text-slate-400 mb-8 font-medium">Trung tâm Cứu hộ Khẩn cấp</p>
      
      <div class="w-full space-y-4">
          <div class="relative">
              <i class="fas fa-user absolute left-4 top-4 text-slate-500"></i>
              <input type="text" id="username" placeholder="Mã định danh" class="w-full pl-11 p-3.5 rounded-xl bg-slate-800/50 border border-slate-700 text-white focus:border-red-500 focus:bg-slate-800 focus:outline-none transition-all placeholder:text-slate-600 font-medium" />
          </div>
          <div class="relative">
              <i class="fas fa-lock absolute left-4 top-4 text-slate-500"></i>
              <input type="password" id="password" placeholder="Mật khẩu bảo mật" class="w-full pl-11 p-3.5 rounded-xl bg-slate-800/50 border border-slate-700 text-white focus:border-red-500 focus:bg-slate-800 focus:outline-none transition-all placeholder:text-slate-600 font-medium" />
          </div>
          <button onclick="login()" class="w-full bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-red-900/40 transform active:scale-[0.98] transition-all flex items-center justify-center gap-2">
            <i class="fas fa-right-to-bracket"></i> ĐĂNG NHẬP
          </button>
      </div>
      <p class="text-xs text-slate-600 mt-6">Hệ thống bảo mật cấp độ cao. Vui lòng không chia sẻ tài khoản.</p>
    </div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminPanel" class="relative z-10 hidden flex flex-col min-h-screen">
    
    <!-- Navbar -->
    <nav class="sticky top-0 z-[100] glass-panel border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-red-600 p-2 rounded-lg">
                    <i class="fas fa-star text-yellow-400"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold text-white leading-none">TRUNG TÂM TÁC CHIẾN</h2>
                    <p class="text-xs text-slate-400 font-mono mt-1">LIVE COMMAND CENTER • v2.5</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/20 text-green-400 text-xs font-bold animate-pulse">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span> ONLINE
                </div>
                <button onclick="logout()" class="bg-slate-800 hover:bg-red-900/80 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors border border-slate-700 hover:border-red-500/50 flex items-center gap-2">
                    <i class="fas fa-power-off"></i> <span class="hidden sm:inline">Thoát</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <main class="flex-1 p-4 md:p-6 max-w-7xl mx-auto w-full space-y-6">

        <!-- Quick Actions Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 fade-in">
            <button onclick="templateEvacuate()" class="group glass-panel p-4 rounded-2xl hover:bg-red-600/20 border-l-4 border-red-500 transition-all flex flex-col items-center gap-2 text-center">
                <i class="fas fa-bullhorn text-2xl text-red-500 group-hover:scale-110 transition-transform"></i>
                <span class="text-xs md:text-sm font-bold text-slate-200">LỆNH DI TẢN</span>
            </button>
            <button onclick="templateFlood()" class="group glass-panel p-4 rounded-2xl hover:bg-blue-600/20 border-l-4 border-blue-500 transition-all flex flex-col items-center gap-2 text-center">
                <i class="fas fa-water text-2xl text-blue-500 group-hover:scale-110 transition-transform"></i>
                <span class="text-xs md:text-sm font-bold text-slate-200">THÔNG BÁO LŨ</span>
            </button>
            <button onclick="exportToExcel()" class="group glass-panel p-4 rounded-2xl hover:bg-green-600/20 border-l-4 border-green-500 transition-all flex flex-col items-center gap-2 text-center">
                <i class="fas fa-file-csv text-2xl text-green-500 group-hover:scale-110 transition-transform"></i>
                <span class="text-xs md:text-sm font-bold text-slate-200">XUẤT DỮ LIỆU</span>
            </button>
            <button onclick="clearAllData()" class="group glass-panel p-4 rounded-2xl hover:bg-slate-700/50 border-l-4 border-slate-500 transition-all flex flex-col items-center gap-2 text-center">
                <i class="fas fa-trash-can text-2xl text-slate-400 group-hover:text-red-500 group-hover:scale-110 transition-transform"></i>
                <span class="text-xs md:text-sm font-bold text-slate-200">XÓA HỆ THỐNG</span>
            </button>
        </div>

        <!-- Main Map Section -->
        <div class="glass-panel rounded-3xl p-1 fade-in">
            <div class="bg-slate-900/50 rounded-[20px] p-4 md:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-map-location-dot text-blue-500"></i> BẢN ĐỒ THỜI GIAN THỰC
                    </h3>
                    <span class="text-xs font-mono text-slate-400" id="lastUpdate">Cập nhật: Vừa xong</span>
                </div>
                
                <!-- Map -->
                <div class="relative rounded-2xl overflow-hidden border border-slate-700 shadow-2xl">
                     <div id="map"></div>
                     <!-- Stats Overlay -->
                     <div class="absolute top-4 right-4 flex flex-col gap-2 z-[400]">
                         <div class="bg-slate-900/90 backdrop-blur border border-slate-700 p-3 rounded-xl shadow-lg flex items-center gap-3 min-w-[140px]">
                             <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center text-red-500"><i class="fas fa-circle-exclamation text-lg"></i></div>
                             <div>
                                 <div class="text-2xl font-bold text-white leading-none" id="victimCount">0</div>
                                 <div class="text-[10px] text-slate-400 uppercase font-bold">Cần Cứu Hộ</div>
                             </div>
                         </div>
                         <div class="bg-slate-900/90 backdrop-blur border border-slate-700 p-3 rounded-xl shadow-lg flex items-center gap-3 min-w-[140px]">
                             <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-500"><i class="fas fa-life-ring text-lg"></i></div>
                             <div>
                                 <div class="text-2xl font-bold text-white leading-none" id="rescueCount">0</div>
                                 <div class="text-[10px] text-slate-400 uppercase font-bold">Đội Cứu Hộ</div>
                             </div>
                         </div>
                     </div>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6 fade-in">
            <!-- Warning Editor -->
            <div class="glass-panel rounded-3xl p-6 flex flex-col">
                <div class="flex items-center gap-2 mb-4">
                    <div class="bg-orange-500/20 p-2 rounded-lg"><i class="fas fa-triangle-exclamation text-orange-500"></i></div>
                    <h3 class="font-bold text-lg text-white">PHÁT LỆNH CẢNH BÁO</h3>
                </div>

                <!-- Toolbar -->
                <div class="bg-slate-800/80 rounded-t-xl p-2 border-b border-slate-700 flex flex-wrap gap-1">
                    <button type="button" onclick="document.execCommand('bold')" class="w-8 h-8 rounded hover:bg-slate-700 text-slate-300"><i class="fas fa-bold"></i></button>
                    <button type="button" onclick="document.execCommand('italic')" class="w-8 h-8 rounded hover:bg-slate-700 text-slate-300"><i class="fas fa-italic"></i></button>
                    <div class="w-px h-6 bg-slate-700 mx-1 self-center"></div>
                    <select onchange="document.execCommand('foreColor', false, this.value)" class="bg-slate-700 text-xs text-white rounded px-2 h-8 outline-none">
                        <option value="#ffffff">Trắng</option><option value="#ff4444">Đỏ</option><option value="#ffeb3b">Vàng</option>
                    </select>
                    <select onchange="document.execCommand('backColor', false, this.value)" class="bg-slate-700 text-xs text-white rounded px-2 h-8 outline-none">
                         <option value="transparent">Ko nền</option><option value="#b91c1c">Nền Đỏ</option>
                    </select>
                </div>
                
                <div id="warnMsg" contenteditable="true" class="flex-1 min-h-[200px] p-4 bg-slate-900/50 rounded-b-xl border border-slate-700 focus:border-orange-500 outline-none text-slate-200 overflow-y-auto mb-4"></div>
                
                <button onclick="addWarning()" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-900/20 transition-all active:scale-[0.98]">
                    <i class="fas fa-paper-plane mr-2"></i> GỬI TOÀN HỆ THỐNG
                </button>
            </div>

            <!-- Rescue Team Registration -->
            <div class="glass-panel rounded-3xl p-6 flex flex-col">
                <div class="flex items-center gap-2 mb-4">
                    <div class="bg-blue-500/20 p-2 rounded-lg"><i class="fas fa-user-shield text-blue-500"></i></div>
                    <h3 class="font-bold text-lg text-white">ĐIỀU PHỐI ĐỘI CỨU HỘ</h3>
                </div>
                
                <div class="space-y-4 flex-1">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Tên Đơn vị / Đội nhóm</label>
                        <input type="text" id="rescueName" class="w-full mt-1 p-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white focus:border-blue-500 focus:bg-slate-800 outline-none transition" placeholder="VD: Đội Xuồng Hơi 01">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Số điện thoại chỉ huy</label>
                        <input type="tel" id="rescuePhone" class="w-full mt-1 p-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white focus:border-blue-500 focus:bg-slate-800 outline-none transition" placeholder="09xxxx">
                    </div>
                    <div class="bg-blue-500/10 p-3 rounded-xl border border-blue-500/20">
                        <p class="text-xs text-blue-300"><i class="fas fa-info-circle mr-1"></i> Đội cứu hộ sau khi đăng ký sẽ xuất hiện icon màu xanh trên bản đồ dân cư.</p>
                    </div>
                </div>

                <button onclick="addRescueTeam()" class="w-full mt-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-900/20 transition-all active:scale-[0.98]">
                    <i class="fas fa-plus-circle mr-2"></i> THÊM ĐỘI VÀO BẢN ĐỒ
                </button>
            </div>
        </div>

        <!-- Data List -->
        <div class="glass-panel rounded-3xl p-6 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white">DỮ LIỆU BÁO CÁO</h3>
                    <p class="text-sm text-slate-400">Danh sách các yêu cầu đang chờ xử lý</p>
                </div>
                <div class="relative w-full md:w-80">
                    <i class="fas fa-search absolute left-3 top-3.5 text-slate-500"></i>
                    <input type="text" id="searchInput" onkeyup="filterReports()" placeholder="Tìm kiếm SĐT, nội dung..." class="w-full pl-10 p-3 bg-slate-800 border border-slate-600 rounded-xl text-white focus:border-blue-500 outline-none">
                </div>
            </div>

            <div class="overflow-hidden rounded-xl border border-slate-700">
                <div id="allReports" class="max-h-[500px] overflow-y-auto divide-y divide-slate-700 bg-slate-900/50">
                    <!-- Items will be injected here -->
                </div>
            </div>
        </div>

    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- CONFIG & STATE ---
    const ADMIN_ACCOUNTS = [
        {username:"admin", password:"1"},
        {username:"chi huy", password:"1"},
        {username:"khanhhoa", password:"1"}
    ];
    let map, markers = L.layerGroup();
    let currentReports = [];

    // --- TEMPLATE FUNCTIONS ---
    function templateEvacuate() {
        const t = document.getElementById('warnMsg');
        t.innerHTML = `
            <div style="text-align: center; padding: 10px; border: 2px dashed #ef4444; border-radius: 8px; background: rgba(220, 38, 38, 0.1);">
                <h2 style="color: #ef4444; margin: 0; font-size: 24px;">LỆNH DI TẢN KHẨN CẤP</h2>
                <div style="background: #ef4444; color: #fff; display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: bold; margin: 8px 0;">KHU VỰC NGUY HIỂM</div>
                <p style="text-align: left; margin-top: 10px;"><strong>⚠️ YÊU CẦU:</strong> Toàn bộ người dân tại vùng trũng thấp di chuyển ngay lên vùng cao/nhà kiên cố.</p>
                <p style="text-align: left;"><strong>⏳ THỜI GIAN:</strong> Phải hoàn thành trước 18:00 hôm nay.</p>
            </div><br>
        `;
    }

    function templateFlood() {
        const t = document.getElementById('warnMsg');
        t.innerHTML = `
            <div style="border-left: 4px solid #3b82f6; padding-left: 10px; background: rgba(59, 130, 246, 0.1); padding: 10px;">
                <h3 style="color: #3b82f6; margin: 0;">⚠️ THÔNG BÁO XẢ LŨ HỒ CHỨA</h3>
                <p>Lúc <strong>... giờ ... phút</strong>, Hồ chứa nước ... sẽ tiến hành xả lũ.</p>
                <p>Lưu lượng xả dự kiến: <strong>... m3/s</strong>.</p>
                <p style="color: #ef4444; font-weight: bold;">Bà con ven sông chú ý neo đậu tàu thuyền.</p>
            </div><br>
        `;
    }

    function exportToExcel() {
        if(currentReports.length === 0) return alert('Không có dữ liệu để xuất!');
        const data = currentReports.map(r => ({
            "Thời gian": r.timestamp,
            "Loại": r.type === 'victim' ? 'Cấp cứu' : (r.type === 'rescue' ? 'Đội cứu hộ' : 'Cảnh báo'),
            "Nội dung": r.message.replace(/<[^>]*>?/gm, ''),
            "SĐT": r.phone || '',
            "Số người": r.people || '',
            "Vĩ độ": r.lat,
            "Kinh độ": r.lng,
            "IP Gửi": r.ip
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "BaoCao_CuuHo");
        XLSX.writeFile(wb, `DuLieu_CuuHo_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    async function clearAllData() {
        const code = prompt("NHẬP MÃ XÁC NHẬN ĐỂ XÓA TOÀN BỘ DỮ LIỆU:\n(Nhập: 'confirm-delete')");
        if(code !== 'confirm-delete') return alert('Mã sai! Hủy thao tác.');
        
        if(confirm('CẢNH BÁO: Hành động này không thể hoàn tác. Bạn chắc chắn chứ?')) {
            const btn = document.querySelector('button[onclick="clearAllData()"]');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> XỬ LÝ...';
            
            for(let r of currentReports) {
                await fetch(`/api/reports/${r.id}`, { method: 'DELETE' });
            }
            alert('Đã xóa sạch dữ liệu hệ thống!');
            loadAllReports();
            btn.innerHTML = originalContent;
        }
    }

    function filterReports() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.report-item');
        items.forEach(item => {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(term) ? 'flex' : 'none';
        });
    }

    // --- CORE FUNCTIONS ---
    function login() {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value;
      if (ADMIN_ACCOUNTS.some(a => a.username === user && a.password === pass)) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('adminPanel').classList.add('flex');
        setTimeout(() => {
            initMap();
            loadAllReports();
            setInterval(loadAllReports, 5000);
        }, 100);
      } else { alert('Sai thông tin đăng nhập!'); }
    }
    
    function logout() { location.reload(); }

    function initMap() {
      if(map) return;
      map = L.map('map', {zoomControl: false}).setView([12.24, 109.19], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      markers.addTo(map);
    }

    function createMarker(r) {
      const isVictim = !r.type || r.type === 'victim';
      const iconClass = isVictim ? 'marker-pin pulse' : r.type === 'rescue' ? 'marker-pin marker-rescue' : 'marker-pin marker-warning';
      
      let iconHtml = '';
      if(isVictim) iconHtml = '<div class="marker-pin pulse"></div>';
      else if (r.type === 'rescue') iconHtml = '<div class="marker-pin marker-rescue"></div>';
      else iconHtml = '<div class="marker-pin marker-warning pulse"></div>';

      const icon = L.divIcon({
          className: "custom-div-icon", 
          html: iconHtml, 
          iconSize: [36, 36], 
          iconAnchor: [18, 36]
      });
      
      const popup = `
        <div class="text-slate-800 min-w-[200px]">
            <div class="font-bold border-b border-gray-200 pb-1 mb-1 text-sm">${r.type === 'rescue' ? 'ĐỘI CỨU HỘ' : (r.type==='warning'?'CẢNH BÁO':'YÊU CẦU CỨU HỘ')}</div>
            <div class="text-sm font-medium mb-1">${r.message}</div>
            ${r.phone ? `<div class="text-blue-600 font-bold text-xs"><i class="fas fa-phone"></i> <a href="tel:${r.phone}">${r.phone}</a></div>` : ''}
            <div class="text-[10px] text-gray-500 mt-1 text-right">${r.timestamp}</div>
        </div>`;
      L.marker([r.lat, r.lng], { icon }).addTo(markers).bindPopup(popup);
    }

    async function loadAllReports() {
      try {
        const res = await fetch('/api/reports?admin=true&t=' + Date.now());
        const reports = await res.json();
        currentReports = reports;
        markers.clearLayers();
        
        let v=0, re=0;
        const html = reports.map(r => {
            if(!r.type || r.type === 'victim') v++;
            if(r.type === 'rescue') re++;
            
            const isVictim = !r.type || r.type === 'victim';
            let borderClass = isVictim ? 'border-red-500 bg-red-500/5' : r.type === 'rescue' ? 'border-blue-500 bg-blue-500/5' : 'border-orange-500 bg-orange-500/5';
            let iconClass = isVictim ? 'text-red-500 fa-circle-exclamation' : r.type === 'rescue' ? 'text-blue-500 fa-life-ring' : 'text-orange-500 fa-triangle-exclamation';
            let title = isVictim ? 'Cứu Hộ' : r.type === 'rescue' ? 'Đội Cứu Hộ' : 'Cảnh Báo';

            return `
            <div class="report-item p-4 flex gap-4 hover:bg-slate-800 transition-colors border-l-4 ${borderClass} group">
                <div class="mt-1">
                    <i class="fas ${iconClass} text-xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">${title}</span>
                        <span class="text-[10px] text-slate-500 font-mono">${r.timestamp}</span>
                    </div>
                    <div class="text-slate-200 font-medium text-sm break-words mb-1">${r.message}</div>
                    <div class="flex flex-wrap gap-2 text-xs">
                        ${r.phone ? `<span class="text-blue-400 bg-blue-500/10 px-2 py-0.5 rounded border border-blue-500/20"><i class="fas fa-phone mr-1"></i> ${r.phone}</span>` : ''}
                        ${r.people ? `<span class="text-slate-400 bg-slate-700/50 px-2 py-0.5 rounded border border-slate-600"><i class="fas fa-users mr-1"></i> ${r.people}</span>` : ''}
                        <span class="text-slate-500 bg-slate-800 px-2 py-0.5 rounded border border-slate-700">IP: ${r.ip || 'Unknown'}</span>
                    </div>
                </div>
                <button onclick="deleteReport(${r.id})" class="text-slate-600 hover:text-red-500 transition-colors p-2 self-start opacity-50 group-hover:opacity-100" title="Xóa">
                    <i class="fas fa-trash-can"></i>
                </button>
            </div>`;
        }).join('');
        
        document.getElementById('victimCount').textContent = v;
        document.getElementById('rescueCount').textContent = re;
        document.getElementById('allReports').innerHTML = html || '<div class="p-8 text-center text-slate-500 italic">Chưa có dữ liệu nào trong hệ thống</div>';
        
        reports.forEach(createMarker);
        
        // Update timestamp
        document.getElementById('lastUpdate').textContent = 'Cập nhật: ' + new Date().toLocaleTimeString('vi-VN');
        
        filterReports(); // Keep search active
      } catch (e) {}
    }

    async function deleteReport(id) {
      if (confirm('Xác nhận xóa báo cáo này khỏi hệ thống?')) {
        await fetch(`/api/reports/${id}`, { method: 'DELETE' });
        loadAllReports();
      }
    }

    async function addWarning() {
      const html = document.getElementById('warnMsg').innerHTML;
      if(!html.trim()) return alert('Vui lòng nhập nội dung cảnh báo!');
      
      const btn = document.querySelector('button[onclick="addWarning()"]');
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ĐANG GỬI...';
      
      try {
          await fetch('/api/reports', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ lat: 12.24, lng: 109.19, message: html, type: 'warning' }) });
          alert('Đã phát lệnh cảnh báo thành công!'); 
          document.getElementById('warnMsg').innerHTML = ''; 
          loadAllReports();
      } catch(e) { alert('Lỗi gửi đi!'); }
      
      btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> GỬI TOÀN HỆ THỐNG';
    }

    async function addRescueTeam() {
        const name = document.getElementById('rescueName').value;
        const phone = document.getElementById('rescuePhone').value;
        if(!name || !phone) return alert('Thiếu thông tin Đội/SĐT');
        
        await fetch('/api/reports', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ lat: 12.24, lng: 109.19, message: `ĐỘI CỨU HỘ: ${name}`, phone, type: 'rescue' }) });
        alert(`Đã thêm đội [${name}] vào bản đồ!`); 
        document.getElementById('rescueName').value = '';
        document.getElementById('rescuePhone').value = '';
        loadAllReports();
    }
  </script>
</body>
</html>
