<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QUẢN TRỊ HỆ THỐNG CỨU HỘ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; margin: 0; }
    .card { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 1.5rem; }
    #map { height: 520px; border-radius: 1rem; border: 3px solid #2563eb; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4); }
    .marker-pin { width: 36px; height: 36px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); background: #ef4444; box-shadow: 0 0 20px #ef4444aa; position: relative; }
    .marker-pin::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 10px; left: 10px; }
    .marker-rescue { background: #3b82f6 !important; box-shadow: 0 0 20px #3b82f6aa !important; }
    .marker-warning { background: #f59e0b !important; box-shadow: 0 0 20px #f59e0baa !important; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.8); } 70% { box-shadow: 0 0 0 25px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
  </style>
</head>
<body class="min-h-screen">

  <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-black">
    <div class="card p-12 rounded-2xl shadow-2xl w-full max-w-lg border border-red-700">
      <div class="text-center mb-8">
        <i class="fas fa-shield-alt text-6xl text-red-500 mb-4"></i>
        <h1 class="text-4xl font-bold text-red-400">QUẢN TRỊ HỆ THỐNG</h1>
      </div>
      <input type="text" id="username" placeholder="Tài khoản" class="w-full p-4 mb-4 rounded-lg bg-slate-800 text-white border border-gray-600 focus:border-red-500 outline-none" />
      <input type="password" id="password" placeholder="Mật khẩu" class="w-full p-4 mb-6 rounded-lg bg-slate-800 text-white border border-gray-600 focus:border-red-500 outline-none" />
      <button onclick="login()" class="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-lg text-xl font-bold">ĐĂNG NHẬP</button>
    </div>
  </div>

  <div id="adminPanel" class="hidden p-6 max-w-7xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-yellow-400">BẢNG ĐIỀU KHIỂN QUẢN TRỊ</h1>
      <button onclick="logout()" class="mt-4 bg-red-700 hover:bg-red-800 px-8 py-3 rounded-lg">Đăng xuất</button>
    </div>

    <div id="map" class="card mb-8"></div>

    <div class="card p-8 mb-8">
      <h2 class="text-2xl font-bold text-orange-400 mb-6">GỬI CẢNH BÁO KHẨN CẤP</h2>
      <div id="warnMsg" contenteditable="true" class="min-h-48 p-6 bg-slate-900 rounded-xl border-2 border-orange-500 text-white text-lg" 
           style="outline:none; max-height:400px; overflow-y:auto;">
        <p style="color:#ff0000; font-size:28px;"><strong>CẢNH BÁO KHẨN CẤP</strong></p>
        <p style="color:#ffff00; background:#dc2626; padding:12px; border-radius:12px; display:inline-block;">LŨ QUÉT - SẠT LỞ ĐẤT</p>
      </div>
      <button onclick="addWarning()" class="mt-6 w-full bg-red-600 hover:bg-red-700 py-5 rounded-xl text-xl font-bold text-white">
        GỬI CẢNH BÁO TOÀN TỈNH
      </button>
    </div>

    <div id="allReports" class="space-y-6"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const ACCOUNTS = [{u:"admin",p:"Lenhan@123"},{u:"khanhhoa",p:"kh2025"},{u:"canbo",p:"cuuho2025"}];
    let map, markers = L.layerGroup();

    function login() {
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      if (ACCOUNTS.some(a => a.u === u && a.p === p)) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        initMap(); loadAllReports(); setInterval(loadAllReports, 8000);
      } else alert('Sai tài khoản hoặc mật khẩu!');
    }

    function logout() {
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
    }

    function initMap() {
      map = L.map('map').setView([12.24, 109.19], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      markers.addTo(map);
    }

    async function loadAllReports() {
      try {
        const res = await fetch('/reports.js?admin=true&t=' + Date.now());
        const reports = await res.json();
        markers.clearLayers();

        document.getElementById('allReports').innerHTML = reports.map(r => `
          <div class="bg-slate-800 p-6 rounded-xl border-l-8 ${r.type==='warning'?'border-orange-500':r.type==='rescue'?'border-blue-500':'border-red-500'}">
            <div class="flex justify-between">
              <div class="prose prose-invert max-w-none" dangerouslySetInnerHTML={{__html: r.message}}></div>
              <button onclick="deleteReport(${r.id})" class="text-red-500 text-3xl">×</button>
            </div>
            ${r.phone ? `<p class="text-green-400 font-bold mt-2">Liên hệ: ${r.phone}</p>` : ''}
            <p class="text-sm text-gray-400">${r.timestamp}</p>
          </div>
        `).join('');

        reports.forEach(r => {
          const icon = L.divIcon({
            className: "custom-div-icon",
            html: `<div class="marker-pin ${r.type==='rescue'?'marker-rescue':r.type==='warning'?'marker-warning':''} pulse"></div>`,
            iconSize: [36, 36], iconAnchor: [18, 36]
          });
          L.marker([r.lat, r.lng], {icon}).addTo(markers)
           .bindPopup(`<b>${r.type==='warning'?'CẢNH BÁO':r.type==='rescue'?'ĐỘI CỨU HỘ':'CẦN CỨU'}</b><hr>${r.message}`);
        });
      } catch(e) { console.error(e); }
    }

    async function addWarning() {
      const html = document.getElementById('warnMsg').innerHTML.trim();
      if (!html) return alert('Nhập nội dung cảnh báo!');
      await fetch('/reports.js', { method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ lat:12.24, lng:109.19, message: html, type:'warning' })
      });
      alert('ĐÃ GỬI CẢNH BÁO!');
      document.getElementById('warnMsg').innerHTML = '';
      loadAllReports();
    }

    async function deleteReport(id) {
      if (confirm('XÓA báo cáo này?')) {
        await fetch(`/reports.js/${id}`, { method: 'DELETE' });
        loadAllReports();
      }
    }
  </script>
</body>
</html>
